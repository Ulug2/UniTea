## Testing Notifications and Deep Links (Unitee)

### 1. Prerequisites

- **Apple Developer account**: active (you already have this).
- **Expo / EAS CLI installed** on your Mac:
  - `npm install -g eas-cli`
- Project already configured for:
  - Push notifications via `expo-notifications` and the `usePushNotifications` hook.
  - Deep links via:
    - Custom scheme: `myunitea://...`
    - iOS `associatedDomains`: `applinks:unitea.app` (set in `app.json`).

---

### 2. Build and distribute via TestFlight

#### 2.1. Configure EAS for iOS

From the project root:

```bash
eas login             # if not logged in
npx expo prebuild     # if you haven't prebuilt yet
eas build:configure   # let EAS manage iOS credentials
```

When prompted, choose **iOS** and allow EAS to manage certificates/profiles (simplest path).

#### 2.2. Create an iOS build

```bash
eas build -p ios --profile production
```

- Wait for the build to finish.
- In the EAS dashboard, submit the build to **App Store Connect**.
- In **App Store Connect → TestFlight**, add your Apple ID as an internal tester and install the app on your iPhone.

---

### 3. Testing push notifications (physical device + TestFlight build)

#### 3.1. Ensure OS-level permissions are enabled

On your iPhone, after installing from TestFlight:

- `Settings` → scroll to **Unitee** → `Notifications`.
- Turn **Allow Notifications** ON (and enable Lock Screen / Banners as you like).

If you previously tapped “Don’t Allow”, this is where you re‑enable it.

#### 3.2. Trigger push token registration

1. Open the **Unitee** app on your device.
2. Sign in with **any email** (NU restriction is disabled for testing).
3. Go to the **Profile** tab (this screen uses `usePushNotifications`).
4. In Supabase, open the `notification_settings` table:
   - You should see a row with your `user_id` and a non‑null `push_token`.

If `push_token` is present, your device is registered for Expo push.

#### 3.3. Send a test push via Expo

1. Copy the `push_token` from `notification_settings`.
2. On your Mac, run:

```bash
curl -X POST https://exp.host/--/api/v2/push/send \
  -H "Content-Type: application/json" \
  -d '{
    "to": "EXPO_PUSH_TOKEN_HERE",
    "title": "Unitee Test",
    "body": "Hello from Unitee push test"
  }'
```

3. Expected behavior:
   - If the app is **foregrounded**, you see an in‑app banner/alert.
   - If the app is **backgrounded** or closed, it appears in Notification Center.

---

### 4. Testing deep links (custom scheme)

Custom scheme is **`myunitea://`**. This works both in dev and in TestFlight builds.

#### 4.1. Test post deep link

The app handles URLs of the form:

- `myunitea://post/<postId>` → opens the detailed post screen.

Steps:

1. Get a real `postId` from your Supabase `posts` table.
2. On your iPhone, open **Safari**.
3. In the address bar, type:

```text
myunitea://post/<your-post-id>
```

4. Tap **Go**:
   - iOS should show an “Open in Unitee?” prompt.
   - The app should open and navigate to `/post/<id>`.

#### 4.2. Test auth callback deep link

The app handles email verification callbacks at:

- `myunitea://auth/callback?access_token=...&refresh_token=...`

To simulate without a real email:

1. On your iPhone, open **Safari**.
2. Enter:

```text
myunitea://auth/callback?access_token=test&refresh_token=test
```

3. Tap **Go**:
   - The app should open (no crash).
   - In dev you’d see `[Deep Link] Received URL:` logs; in TestFlight just confirm the app opens.

(Real links will be generated by Supabase when you sign up.)

---

### 5. Testing universal links (`https://unitea.app/...`) – optional

Universal links require **server-side setup** in addition to the iOS `associatedDomains`.

#### 5.1. Apple App Site Association (AASA)

On `https://unitea.app`, host a JSON file at:

- `https://unitea.app/.well-known/apple-app-site-association`

Example:

```json
{
  "applinks": {
    "apps": [],
    "details": [
      {
        "appID": "<TEAM_ID>.com.unitea.app",
        "paths": ["/post/*", "/auth/*", "/*"]
      }
    ]
  }
}
```

- Replace `<TEAM_ID>` with your Apple Developer **Team ID**.

#### 5.2. Test universal links

After AASA is set up and your TestFlight build is installed:

1. On your iPhone, open **Safari**.
2. Visit:

```text
https://unitea.app/post/<postId>
```

3. If correctly configured, Safari should open **Unitee** instead of just loading the website.

If universal links aren’t critical yet, you can rely on `myunitea://...` links for testing.

